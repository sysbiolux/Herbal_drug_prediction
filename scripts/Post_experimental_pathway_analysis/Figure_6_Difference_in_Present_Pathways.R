WORKING_DIR = ''
setwd(WORKING_DIR)
setwd('./Herbal_drug_prediction/scripts/')
library(tidyverse)
library(readr)
library("viridis")           
library(ggpubr)
# Plot the Difference_in_Present_Pathways for the 3 tested herbal drugs

#read percentage_enrichment_subsystem.csv file generated by matlab
percentage_enrichment_subsystem <- read_csv("../results//Models_rxn_per_pathway.csv")
percentage_enrichment_subsystem$drug <- gsub(" ", ".", percentage_enrichment_subsystem$drug)
percentage_enrichment_subsystem$drug <-  gsub('_removed_unused_genes', "", percentage_enrichment_subsystem$drug)
# keep all herbal drugs without DMSO
drugs <- percentage_enrichment_subsystem %>%
  filter(!grepl('DMSO', drug))

# keep DMSO
dmso <- percentage_enrichment_subsystem %>%
  filter(grepl("DMSO",drug))

#merge 2 arrays bu pathway
DE_pathways <- inner_join(drugs, dmso, by = 'pathway')

# difference between herbal drugs and DMSO
DE_pathways$RXN_per_pathway_diff <- DE_pathways$Rxn_per_pathway.x - DE_pathways$Rxn_per_pathway.y

#create a pivot table
pivotting_table <- DE_pathways %>%
  select(drug.x, pathway, RXN_per_pathway_diff) %>%
  spread(key = pathway, value = RXN_per_pathway_diff ) 

colnames(pivotting_table)[1] <- 'drug'

## use the first column as rownames
pivotting_table <- data.frame(column_to_rownames(pivotting_table, var = "drug"))
## clustering the pathways 
pathway_dendogram <- hclust(dist(t(as.matrix(pivotting_table))))
## find the order of clustered pathways
pathways_order <- pathway_dendogram$order
## create a matrix with pivotting_table
df1 <- as.matrix(pivotting_table)
## setting this matrix with the ordered pathways
df1 <- df1[,pathways_order]
dat_long <- reshape2::melt(df1)
## change the name of 1 and 2 columns
names(dat_long)[1] <- 'drug'
names(dat_long)[2] <- 'pathway'


# Build a violin plot of the DE pathways 

library(ggplot2)
library(ggbeeswarm)

DE_pathways_filtered = DE_pathways
DE_pathways$RXN_per_pathway_diff

DE_pathways_filtered%>%
  group_by(pathway)%>% 
  mutate(abs_median=median(abs(RXN_per_pathway_diff))) ->DE_pathways_filtered
#DE_pathways_filtered <- DE_pathways_filtered[DE_pathways_filtered$abs_median>0,]
DE_pathways_filtered <- DE_pathways_filtered[rev(order(DE_pathways_filtered$abs_median)),]

## Remove pathways with 3 rxns or less
pathway_rxn_count = read.csv('../results/Recon3d_pathway_total_counts.csv')
pathways_with_four_rxns = pathway_rxn_count[pathway_rxn_count$count>3,'pathway']
pathways_with_three_rxns = pathway_rxn_count[pathway_rxn_count$count<=3,'pathway']
DE_pathways_filtered <- DE_pathways_filtered[DE_pathways_filtered$pathway %in% pathways_with_four_rxns,]
DE_pathways_filtered <- left_join(DE_pathways_filtered,pathway_rxn_count)

DE_pathways_filtered%>%
  group_by(pathway)%>% 
  mutate(sum_abs=sum(abs(RXN_per_pathway_diff))) ->DE_pathways_filtered
length(unique(DE_pathways_filtered$pathway))
unique(DE_pathways_filtered$pathway)
DE_pathways_filtered <- DE_pathways_filtered[rev(order(DE_pathways_filtered$sum_abs)),]

DE_pathways_filtered$drug.x <- str_replace_all(DE_pathways_filtered$drug.x ,"\\."," ")

### Find the DA for the 3 drugs with cell assay results
targeted_drugs <- c('Bruceine D','Emodin','Scutellarein')

targeted_DE <- DE_pathways_filtered[DE_pathways_filtered$drug.x %in% targeted_drugs ,]
# Select only pathway that have at least aboulte more than 10% difference
targeted_DE <- targeted_DE[abs(targeted_DE$RXN_per_pathway_diff)>=.10,]

# Sort pathways withe the order of Bruceine D
targeted_DE_brc <- targeted_DE[ targeted_DE$drug.x=='Bruceine D',]

targeted_DE_brc_pathways <- targeted_DE_brc[order(abs(targeted_DE_brc$RXN_per_pathway_diff),decreasing = TRUE),'pathway']
`%not_in%` <- purrr::negate(`%in%`)
pathways_not_in_brc = unique(targeted_DE$pathway)[unique(targeted_DE$pathway) %not_in% targeted_DE_brc_pathways$pathway]
brc_pathways_all_sorted <- c(targeted_DE_brc_pathways$pathway,pathways_not_in_brc)

## Reselected again the DE values to show differences evenif it has small values
targeted_DE <- DE_pathways_filtered[DE_pathways_filtered$drug.x %in% targeted_drugs & DE_pathways_filtered$pathway %in% brc_pathways_all_sorted,]

## set features for barplot
p7 <- targeted_DE %>%
  #utate(pathway = fct_reorder2(pathway, abs(RXN_per_pathway_diff),drug.x=='Bruceine.D')) %>%
  ggplot(aes(x= RXN_per_pathway_diff, y= factor(targeted_DE$pathway,levels = rev(brc_pathways_all_sorted)),fill=count)) + 
  xlab('Difference of reaction presence\nrate between the herbal and DMSO models') + 
  ylab('Pathways') +
  geom_bar(stat="identity", width=0.8,position="dodge") + #,fill='steelblue'
  theme_bw(base_size = 19)+
  
  theme(axis.text.y = element_text(size = 20, hjust = 1,face = 'bold'),
        axis.text.x = element_text(size = 18, hjust = 1,face = 'bold'),
        axis.title.y =element_text(vjust = 1.5, size = 20,face = 'bold'),
        axis.title.x = element_text( size = 19,face = 'bold'),
        legend.title = element_text(size=17,face = 'bold'),
        strip.text = element_text(size = 20,face = 'bold'))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #theme_minimal(base_size = 16) +
  facet_wrap(.~drug.x,scales = 'fixed')+
  scale_fill_gradientn(name='Total Number\nof Reactions',colours = magma(8),trans='log',breaks = c(10,25, 50, 100,250,500,1000))#, breaks = c(0, 0.1, 0.25,0.5,0.75,1)+

p7

png("../figures/Figure_6_Tested_drugs_rxn_per_pathways.png",height  = 16,  width= 17, res = 300,units = 'in')
p7
dev.off()

# save as SVG and pdf
ggsave(file="../figures/PDF/Figure_6_Tested_drugs_rxn_per_pathways.pdf", plot=p7, width=16, height=17,dpi = 300)
ggsave(file="../figures/SVG/Figure_6_Tested_drugs_rxn_per_pathways.svg", plot=p7, width=16, height=17,dpi = 300)

### Find the DA for the 3 drugs with cell assay results for all pathways ( No filters)
targeted_drugs <- c('Bruceine D','Emodin','Scutellarein')

targeted_DE <- DE_pathways_filtered[DE_pathways_filtered$drug.x %in% targeted_drugs ,]
# Select only pathway that have at least aboulte more than 10% difference
targeted_DE <- targeted_DE[abs(targeted_DE$RXN_per_pathway_diff)!=0,]

# Sort pathways withe the order of Bruceine D
targeted_DE_brc <- targeted_DE[ targeted_DE$drug.x=='Bruceine D',]
targeted_DE_brc_pathways <- targeted_DE_brc[order(abs(targeted_DE_brc$RXN_per_pathway_diff),decreasing = TRUE),'pathway']
`%not_in%` <- purrr::negate(`%in%`)
pathways_not_in_brc = unique(targeted_DE$pathway)[unique(targeted_DE$pathway) %not_in% targeted_DE_brc_pathways$pathway]
brc_pathways_all_sorted <- c(targeted_DE_brc_pathways$pathway,pathways_not_in_brc)

## Reselected again the DE values to show differences evenif it has small values
targeted_DE <- DE_pathways_filtered[DE_pathways_filtered$drug.x %in% targeted_drugs & DE_pathways_filtered$pathway %in% brc_pathways_all_sorted,]

## set features for barplot
p7 <- targeted_DE %>%
  #utate(pathway = fct_reorder2(pathway, abs(RXN_per_pathway_diff),drug.x=='Bruceine.D')) %>%
  ggplot(aes(x= RXN_per_pathway_diff, y= factor(targeted_DE$pathway,levels = rev(brc_pathways_all_sorted)),fill=count)) + 
  xlab('Difference of reaction presence rate\nbetween the herbal and DMSO models') + 
  ylab('Pathways') +
  geom_bar(stat="identity", width=0.8,position="dodge") + #,fill='steelblue'
  theme_bw(base_size = 18)+
  
  theme(axis.text.y = element_text(size = 18, hjust = 1,face = 'bold'),
        axis.text.x = element_text(size = 18, hjust = 1,face = 'bold'),
        axis.title.y =element_text(vjust = 1.5, size = 19,face = 'bold'),
        axis.title.x = element_text( size = 19,face = 'bold'),
        legend.title = element_text(size=16,face = 'bold'),
        strip.text = element_text(size = 20,face = 'bold'))+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  #theme_minimal(base_size = 16) +
  facet_wrap(.~drug.x,scales = 'fixed')+
  scale_fill_gradientn(name='Total Number\nof Reactions',colours = magma(8),trans='log',breaks = c(10,25, 50, 100,250,500,1000))#, breaks = c(0, 0.1, 0.25,0.5,0.75,1)+

p7

png("../figures/Figure_S6_Tested_drugs_rxn_per_pathways_all_pathways.png",height  = 20,  width= 18, res = 300,units = 'in')
p7
dev.off()
# save as SVG and pdf
ggsave(file="../figures/PDF/Figure_6_Tested_drugs_rxn_per_pathways_all_pathways.pdf", plot=p7, width=20, height=18,dpi = 300)
ggsave(file="../figures/SVG/Figure_6_Tested_drugs_rxn_per_pathways_all_pathways.svg", plot=p7, width=20, height=18,dpi = 300)
